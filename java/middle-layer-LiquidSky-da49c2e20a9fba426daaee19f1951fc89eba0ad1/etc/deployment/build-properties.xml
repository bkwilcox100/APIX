<?xml version="1.0" encoding="UTF-8"?>

<project name="Build Properties">

	<target name="-init-properties">
		<_set-property name="APP_ENGINE_APP_ID" value="${appengine.app.id}" />
	</target>

	<target name="-set-properties" depends="-init,-init-properties,-set-sql-properties,-set-firebase-properties,-set-pubsub-properties,-set-memcache-properties" />

	<target name="-set-sql-properties">
		<input message="Please enter Cloud SQL hebdb user password [CLOUD_SQL_DATABASE_PASSWORD]: " addproperty="appengine.cloudsql-database-password" />
		<_set-property name="CLOUD_SQL_DATABASE_PASSWORD" value="${appengine.cloudsql-database-password}" />
		<_set-property name="CLOUD_SQL_DATABASE_URL" value="jdbc:mysql://google/middle_layer?cloudSqlInstance=${appengine.app.id}:us-central1:${project.sql.instance.id}&amp;socketFactory=com.google.cloud.sql.mysql.SocketFactory&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=false" />
	</target>

	<target name="-set-firebase-properties">
		<echo>
The Firebase server key can be found at https://console.firebase.google.com/project/${appengine.app.id}/settings/cloudmessaging
		</echo>
		<input message="Please enter the Firebase Server key [FIREBASE_KEY]: " addproperty="appengine.fcm.key" />
		<_set-property name="FIREBASE_KEY" value="${appengine.fcm.key}" />
		<echo>
The following Firebase values can be found by doing the following:

1. Go to https://console.firebase.google.com/project/${appengine.app.id}/settings/general/
2. Click on the 'Add Firebase to your web app' button
		</echo>
		<input message="Please enter the Firebase apiKey [FIREBASE_API_KEY]: " addproperty="appengine.fcm.apiKey" />
		<_set-property name="FIREBASE_API_KEY" value="${appengine.fcm.apiKey}" />
		<_set-property name="FIREBASE_AUTH_DOMAIN" value="${appengine.app.id}.firebaseapp.com" />
		<_set-property name="FIREBASE_DATABASE_URL" value="https://${appengine.app.id}.firebaseio.com" />
		<_set-property name="FIREBASE_STORAGE_BUCKET" value="${appengine.app.id}.appspot.com" />
		<input message="Please enter the Firebase messagingSenderId [FIREBASE_MESSAGING_SENDER_ID]: " addproperty="appengine.fcm.messagingSenderId" />
		<_set-property name="FIREBASE_MESSAGING_SENDER_ID" value="${appengine.fcm.messagingSenderId}" />
	</target>

	<target name="-set-pubsub-properties">
		<_set-property name="PUBSUB_PUSH_ENDPOINT" value="https://taskqueue-dot-${appengine.app.id}.appspot.com/pubSubServlet" />
	</target>

	<target name="-set-memcache-properties">
		<echo>
If memory store is not enabled do not enter host/port values.  If memory store is enabled:

1. Go to https://console.cloud.google.com/memorystore/instances?memorystore=true&amp;project=${appengine.app.id}
2. Host/port can be found under the 'endpoint' column.
		</echo>
		<input message="Please enter the memory store host [MEMORY_STORE_HOST] (example: '169.254.10.2'): " addproperty="appengine.memorystore.host" />
		<_set-property name="MEMORY_STORE_HOST" value="${appengine.memorystore.host}" />
		<input message="Please enter the memory store port [MEMORY_STORE_PORT] (example: '11211'): " addproperty="appengine.memorystore.port" />
		<_set-property name="MEMORY_STORE_PORT" value="${appengine.memorystore.port}" />
	</target>

	<macrodef name="_set-property">
		<attribute name="name" />
		<attribute name="value" />
		<attribute name="sub-directory" default="app-settings" />
		<attribute name="key-id" default="@{sub-directory}" />
		<attribute name="unencrypted-filename" default="${build.tmp.dir}/@{name}.property" />
		<attribute name="encrypted-filename" default="@{unencrypted-filename}.encrypted" />
		<sequential>
			<echo file="@{unencrypted-filename}" append="false">@{value}</echo>
			<exec executable="gcloud" failonerror="true">
				<arg line="kms encrypt --project=${appengine.app.id} --ciphertext-file=@{encrypted-filename} --plaintext-file=@{unencrypted-filename} --location=${cloud.location.id} --key=@{key-id} --keyring=${cloud.keyring.id}" />
			</exec>
			<exec executable="gsutil" failonerror="true">
				<arg line="cp @{encrypted-filename} ${cloud.properties.dir}/@{sub-directory}/@{name}.property" />
			</exec>
		</sequential>
	</macrodef>
</project>
